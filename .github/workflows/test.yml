name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    name: Lint Lua Files
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Lua
        uses: leafo/gh-actions-lua@v10
        with:
          luaVersion: "5.4"

      - name: Install Luacheck
        run: |
          sudo apt-get update
          sudo apt-get install -y luarocks
          sudo luarocks install luacheck

      - name: Run Luacheck
        run: |
          luacheck lua/ --no-unused-args --no-max-line-length || true
        continue-on-error: true

  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker compose build nvim-ultimate-test

      - name: Verify Docker build
        run: |
          docker images | grep nvim-ultimate

  test-scripts:
    name: Test Scripts Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate shell scripts
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
          shellcheck install.sh update.sh uninstall.sh tests/*.sh || true
        continue-on-error: true

      - name: Check scripts are executable
        run: |
          test -x install.sh
          test -x update.sh
          test -x uninstall.sh
          test -x tests/test-profile.sh
          test -x tests/test-themes.sh
          test -x tests/benchmark.sh

  docker-tests:
    name: Run Tests in Docker
    runs-on: ubuntu-latest
    needs: docker-build
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test image
        run: docker compose build nvim-ultimate-test

      - name: Run benchmark tests
        run: |
          docker compose run --rm nvim-ultimate-test bash -c "cd /home/nvim && ./tests/benchmark.sh" || true
        continue-on-error: true

      - name: Test minimal profile
        run: |
          docker compose run --rm nvim-ultimate-test bash -c "cd /home/nvim && ./tests/test-profile.sh minimal" || true
        continue-on-error: true

      - name: Verify test completion
        run: |
          echo "Docker tests completed"

  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install markdown-link-check
        run: npm install -g markdown-link-check

      - name: Check markdown links
        run: |
          for file in *.md; do
            echo "Checking $file"
            markdown-link-check "$file" --config .github/markdown-link-check-config.json || true
          done
        continue-on-error: true

      - name: Verify documentation files exist
        run: |
          test -f README.md
          test -f CHANGELOG.md
          test -f LICENSE
          test -f CONTRIBUTING.md
          test -f THEMES.md
          test -f ICONS.md
          test -f CUSTOMIZATION.md

  profile-validation:
    name: Validate Profile Configuration
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate profile.json
        run: |
          if command -v jq &> /dev/null; then
            jq empty profile.json
          else
            python3 -m json.tool profile.json > /dev/null
          fi

      - name: Check profile structure
        run: |
          test -f profile.json
          grep -q "active_profile" profile.json
          grep -q "ui_preferences" profile.json
          grep -q "components" profile.json

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [lint, docker-build, test-scripts, docker-tests, documentation, profile-validation]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "Lint: ${{ needs.lint.result }}"
          echo "Docker Build: ${{ needs.docker-build.result }}"
          echo "Test Scripts: ${{ needs.test-scripts.result }}"
          echo "Docker Tests: ${{ needs.docker-tests.result }}"
          echo "Documentation: ${{ needs.documentation.result }}"
          echo "Profile Validation: ${{ needs.profile-validation.result }}"
